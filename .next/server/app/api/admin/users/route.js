"use strict";(()=>{var e={};e.id=628,e.ids=[628],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},72231:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>h,requestAsyncStorage:()=>E,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>N});var s={};r.r(s),r.d(s,{DELETE:()=>f,GET:()=>m,PUT:()=>p});var a=r(49303),i=r(88716),n=r(60670),o=r(87070),l=r(20728),u=r(89155),c=r(9133);let d=c.z.object({id:c.z.string().uuid(),role:c.z.enum(["USER","ADMIN"]).optional(),firstName:c.z.string().min(1).optional(),lastName:c.z.string().min(1).optional(),city:c.z.string().optional(),state:c.z.string().optional()});async function m(e){let t=await (0,u.OS)(u.K$.ADMIN);if(t)return t;try{let{searchParams:t}=new URL(e.url),r=parseInt(t.get("page")||"1"),s=parseInt(t.get("limit")||"10"),a=t.get("search")||"",i=t.get("role")||void 0,n=(r-1)*s,u={};a&&(u.OR=[{email:{contains:a,mode:"insensitive"}},{firstName:{contains:a,mode:"insensitive"}},{lastName:{contains:a,mode:"insensitive"}}]),i&&("USER"===i||"ADMIN"===i)&&(u.role=i);let[c,d]=await Promise.all([l._.user.findMany({where:u,select:{id:!0,email:!0,firstName:!0,lastName:!0,city:!0,state:!0,role:!0,createdAt:!0,emailVerified:!0,_count:{select:{auditLogs:!0}}},orderBy:{createdAt:"desc"},skip:n,take:s}),l._.user.count({where:u})]);return o.NextResponse.json({users:c,pagination:{page:r,limit:s,total:d,pages:Math.ceil(d/s)}})}catch(e){return console.error("Error fetching users:",e),o.NextResponse.json({error:"Failed to fetch users"},{status:500})}}async function p(e){let t=await (0,u.OS)(u.K$.ADMIN);if(t)return t;try{let t=await e.json(),{id:r,...s}=d.parse(t),a=await l._.user.findUnique({where:{id:r},select:{id:!0,email:!0,role:!0}});if(!a)return o.NextResponse.json({error:"User not found"},{status:404});let i=await l._.user.update({where:{id:r},data:s,select:{id:!0,email:!0,firstName:!0,lastName:!0,city:!0,state:!0,role:!0,updatedAt:!0}});return await l._.auditLog.create({data:{eventType:"USER_UPDATED_BY_ADMIN",details:{targetUserId:r,targetUserEmail:a.email,changes:s,previousRole:a.role}}}),o.NextResponse.json({message:"User updated successfully",user:i})}catch(e){if(e instanceof c.z.ZodError)return o.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});return console.error("Error updating user:",e),o.NextResponse.json({error:"Failed to update user"},{status:500})}}async function f(e){let t=await (0,u.OS)(u.K$.ADMIN);if(t)return t;try{let{searchParams:t}=new URL(e.url),r=t.get("id");if(!r)return o.NextResponse.json({error:"User ID is required"},{status:400});let s=await l._.user.findUnique({where:{id:r},select:{id:!0,email:!0,role:!0}});if(!s)return o.NextResponse.json({error:"User not found"},{status:404});return await l._.user.delete({where:{id:r}}),await l._.auditLog.create({data:{eventType:"USER_DELETED_BY_ADMIN",details:{deletedUserId:r,deletedUserEmail:s.email,deletedUserRole:s.role}}}),o.NextResponse.json({message:"User deleted successfully"})}catch(e){return console.error("Error deleting user:",e),o.NextResponse.json({error:"Failed to delete user"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:"app/api/admin/users/route"},resolvedPagePath:"/Users/viniciusalbino/Documents/GitHub/clausediff.nosync/app/api/admin/users/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:E,staticGenerationAsyncStorage:N,serverHooks:_}=g,y="/api/admin/users/route";function h(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:N})}},26109:(e,t,r)=>{r.d(t,{L:()=>d});var s=r(77234),a=r(53797),i=r(13539),n=r(20728),o=r(42023),l=r.n(o),u=r(9133);let c=u.z.object({email:u.z.string().email(),password:u.z.string().min(6)}),d={adapter:(0,i.N)(n._),providers:[(0,a.Z)({name:"Email e Senha",credentials:{email:{label:"Email",type:"email",placeholder:"seu@email.com"},password:{label:"Senha",type:"password"}},async authorize(e){let t=c.safeParse(e);if(!t.success)throw Error("Credenciais inv\xe1lidas");let{email:r,password:s}=t.data,a=await n._.user.findUnique({where:{email:r}});if(!a||!a.password||!await l().compare(s,a.password))throw Error("Usu\xe1rio ou senha inv\xe1lidos");return{id:a.id,email:a.email,name:a.name||`${a.firstName||""} ${a.lastName||""}`.trim()||null,image:a.image,firstName:a.firstName,lastName:a.lastName,emailVerified:a.emailVerified,role:a.role}}}),...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,s.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{scope:"openid email profile"}},profile:e=>({id:e.sub,name:e.name||null,email:e.email,image:e.picture||null,emailVerified:e.email_verified?new Date:null,firstName:e.given_name||null,lastName:e.family_name||null})})]:[]],session:{strategy:"jwt",maxAge:2592e3,updateAge:86400},jwt:{maxAge:900},pages:{signIn:"/login",error:"/login"},useSecureCookies:!0,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"strict",path:"/",secure:!0}},callbackUrl:{name:"__Secure-next-auth.callback-url",options:{httpOnly:!0,sameSite:"strict",path:"/",secure:!0}},csrfToken:{name:"__Host-next-auth.csrf-token",options:{httpOnly:!1,sameSite:"strict",path:"/",secure:!0}}},callbacks:{async signIn({user:e,account:t,profile:r}){if(t?.provider==="google"&&r&&e.id){let t={};r.picture&&r.picture!==e.image&&(t.image=r.picture);let s=r.email_verified?new Date:null,a=e.emailVerified;if(s?.getTime()!==(a instanceof Date?a.getTime():null)&&(t.emailVerified=s),r.given_name&&r.given_name!==e.firstName&&(t.firstName=r.given_name),r.family_name&&r.family_name!==e.lastName&&(t.lastName=r.family_name),r.name&&r.name!==e.name&&(t.name=r.name),Object.keys(t).length>0)try{await n._.user.update({where:{id:e.id},data:t})}catch(e){console.error("Error updating user in signIn callback:",e)}}return!0},async jwt({token:e,user:t}){t&&(e.id=t.id,e.role=t.role,e.firstName=t.firstName,e.lastName=t.lastName,e.city=t.city,e.state=t.state,e.cpf=t.cpf,e.emailVerified=t.emailVerified);let r=Math.floor(Date.now()/1e3),s=e.iat||r;if(r-s>300&&e.email)try{let t=await n._.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,firstName:!0,lastName:!0,city:!0,state:!0,cpf:!0,role:!0,emailVerified:!0}});t&&(e.id=t.id,e.role=t.role,e.firstName=t.firstName,e.lastName=t.lastName,e.city=t.city,e.state=t.state,e.cpf=t.cpf,e.emailVerified=t.emailVerified,e.iat=r)}catch(e){console.error("Error refreshing JWT token:",e)}return e},session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role,e.user.firstName=t.firstName,e.user.lastName=t.lastName,e.user.city=t.city,e.user.state=t.state,e.user.cpf=t.cpf,e.user.emailVerified=t.emailVerified),e),redirect:async({url:e,baseUrl:t})=>e.startsWith("/")?`${t}${e}`:new URL(e).origin===t?e:t}}},89155:(e,t,r)=>{r.d(t,{K$:()=>i,MJ:()=>d,OS:()=>m,_I:()=>n});var s=r(45609);r(20330);var a=r(26109);let i={USER:"USER",ADMIN:"ADMIN"},n={DOCUMENT_READ:"document:read",DOCUMENT_WRITE:"document:write",DOCUMENT_DELETE:"document:delete",DOCUMENT_SHARE:"document:share",USER_READ:"user:read",USER_WRITE:"user:write",USER_DELETE:"user:delete",ADMIN_PANEL:"admin:panel",AUDIT_LOG_READ:"audit:read",SYSTEM_CONFIG:"system:config"},o={[i.USER]:[n.DOCUMENT_READ,n.DOCUMENT_WRITE,n.DOCUMENT_DELETE,n.DOCUMENT_SHARE],[i.ADMIN]:[...Object.values(n)]};async function l(e){var t;let r=await (0,s.getServerSession)(a.L);return!!r?.user?.role&&!!(t=r.user.role)&&(t&&o[t]||[]).includes(e)}async function u(e){let t=await (0,s.getServerSession)(a.L);return!!t?.user?.role&&t.user.role===e}async function c(){let e=await (0,s.getServerSession)(a.L);return e?.user?null:new Response(JSON.stringify({error:"Unauthorized",message:"Authentication required",code:"AUTH_REQUIRED"}),{status:401,headers:{"Content-Type":"application/json"}})}async function d(e){return await c()||(await l(e)?null:new Response(JSON.stringify({error:"Forbidden",message:`Missing required permission: ${e}`,code:"INSUFFICIENT_PERMISSIONS"}),{status:403,headers:{"Content-Type":"application/json"}}))}async function m(e){return await c()||(await u(e)?null:new Response(JSON.stringify({error:"Forbidden",message:`Missing required role: ${e}`,code:"INSUFFICIENT_ROLE"}),{status:403,headers:{"Content-Type":"application/json"}}))}},20728:(e,t,r)=>{r.d(t,{_:()=>a});let s=require("@prisma/client"),a=globalThis.prisma??new s.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,532,70,23,330,575],()=>r(72231));module.exports=s})();