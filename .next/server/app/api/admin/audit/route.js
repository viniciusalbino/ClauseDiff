"use strict";(()=>{var e={};e.id=827,e.ids=[827],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},5686:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>E,patchFetch:()=>_,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var r={};a.r(r),a.d(r,{DELETE:()=>c,GET:()=>d});var i=a(49303),s=a(88716),n=a(60670),o=a(87070),l=a(20728),u=a(89155);async function d(e){let t=await (0,u.MJ)(u._I.AUDIT_LOG_READ);if(t)return t;try{let{searchParams:t}=new URL(e.url),a=parseInt(t.get("page")||"1"),r=parseInt(t.get("limit")||"20"),i=t.get("eventType")||void 0,s=t.get("userId")||void 0,n=t.get("startDate")||void 0,u=t.get("endDate")||void 0,d=(a-1)*r,c={};i&&(c.eventType=i),s&&(c.userId=s),(n||u)&&(c.timestamp={},n&&(c.timestamp.gte=new Date(n)),u&&(c.timestamp.lte=new Date(u)));let[m,p]=await Promise.all([l._.auditLog.findMany({where:c,include:{user:{select:{id:!0,email:!0,firstName:!0,lastName:!0,role:!0}}},orderBy:{timestamp:"desc"},skip:d,take:r}),l._.auditLog.count({where:c})]),g=await l._.auditLog.groupBy({by:["eventType"],_count:{id:!0},where:{timestamp:{gte:new Date(Date.now()-864e5)}}});return o.NextResponse.json({auditLogs:m,pagination:{page:a,limit:r,total:p,pages:Math.ceil(p/r)},statistics:{eventTypes:g,totalLast24h:g.reduce((e,t)=>e+t._count.id,0)}})}catch(e){return console.error("Error fetching audit logs:",e),o.NextResponse.json({error:"Failed to fetch audit logs"},{status:500})}}async function c(e){let t=await (0,u.MJ)(u._I.AUDIT_LOG_READ);if(t)return t;try{let{searchParams:t}=new URL(e.url),a=parseInt(t.get("olderThanDays")||"90");if(a<30)return o.NextResponse.json({error:"Cannot delete audit logs newer than 30 days"},{status:400});let r=new Date(Date.now()-864e5*a),i=await l._.auditLog.deleteMany({where:{timestamp:{lt:r}}});return await l._.auditLog.create({data:{eventType:"AUDIT_LOG_CLEANUP",details:{deletedCount:i.count,cutoffDate:r.toISOString(),olderThanDays:a}}}),o.NextResponse.json({message:`Deleted ${i.count} audit log entries older than ${a} days`,deletedCount:i.count})}catch(e){return console.error("Error deleting audit logs:",e),o.NextResponse.json({error:"Failed to delete audit logs"},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/audit/route",pathname:"/api/admin/audit",filename:"route",bundlePath:"app/api/admin/audit/route"},resolvedPagePath:"/Users/viniciusalbino/Documents/GitHub/clausediff.nosync/app/api/admin/audit/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:f}=m,E="/api/admin/audit/route";function _(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},26109:(e,t,a)=>{a.d(t,{L:()=>c});var r=a(77234),i=a(53797),s=a(13539),n=a(20728),o=a(42023),l=a.n(o),u=a(9133);let d=u.z.object({email:u.z.string().email(),password:u.z.string().min(6)}),c={adapter:(0,s.N)(n._),providers:[(0,i.Z)({name:"Email e Senha",credentials:{email:{label:"Email",type:"email",placeholder:"seu@email.com"},password:{label:"Senha",type:"password"}},async authorize(e){let t=d.safeParse(e);if(!t.success)throw Error("Credenciais inv\xe1lidas");let{email:a,password:r}=t.data,i=await n._.user.findUnique({where:{email:a}});if(!i||!i.password||!await l().compare(r,i.password))throw Error("Usu\xe1rio ou senha inv\xe1lidos");return{id:i.id,email:i.email,name:i.name||`${i.firstName||""} ${i.lastName||""}`.trim()||null,image:i.image,firstName:i.firstName,lastName:i.lastName,emailVerified:i.emailVerified,role:i.role}}}),...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,r.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{scope:"openid email profile"}},profile:e=>({id:e.sub,name:e.name||null,email:e.email,image:e.picture||null,emailVerified:e.email_verified?new Date:null,firstName:e.given_name||null,lastName:e.family_name||null})})]:[]],session:{strategy:"jwt",maxAge:2592e3,updateAge:86400},jwt:{maxAge:900},pages:{signIn:"/login",error:"/login"},useSecureCookies:!0,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"strict",path:"/",secure:!0}},callbackUrl:{name:"__Secure-next-auth.callback-url",options:{httpOnly:!0,sameSite:"strict",path:"/",secure:!0}},csrfToken:{name:"__Host-next-auth.csrf-token",options:{httpOnly:!1,sameSite:"strict",path:"/",secure:!0}}},callbacks:{async signIn({user:e,account:t,profile:a}){if(t?.provider==="google"&&a&&e.id){let t={};a.picture&&a.picture!==e.image&&(t.image=a.picture);let r=a.email_verified?new Date:null,i=e.emailVerified;if(r?.getTime()!==(i instanceof Date?i.getTime():null)&&(t.emailVerified=r),a.given_name&&a.given_name!==e.firstName&&(t.firstName=a.given_name),a.family_name&&a.family_name!==e.lastName&&(t.lastName=a.family_name),a.name&&a.name!==e.name&&(t.name=a.name),Object.keys(t).length>0)try{await n._.user.update({where:{id:e.id},data:t})}catch(e){console.error("Error updating user in signIn callback:",e)}}return!0},async jwt({token:e,user:t}){t&&(e.id=t.id,e.role=t.role,e.firstName=t.firstName,e.lastName=t.lastName,e.city=t.city,e.state=t.state,e.cpf=t.cpf,e.emailVerified=t.emailVerified);let a=Math.floor(Date.now()/1e3),r=e.iat||a;if(a-r>300&&e.email)try{let t=await n._.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,firstName:!0,lastName:!0,city:!0,state:!0,cpf:!0,role:!0,emailVerified:!0}});t&&(e.id=t.id,e.role=t.role,e.firstName=t.firstName,e.lastName=t.lastName,e.city=t.city,e.state=t.state,e.cpf=t.cpf,e.emailVerified=t.emailVerified,e.iat=a)}catch(e){console.error("Error refreshing JWT token:",e)}return e},session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role,e.user.firstName=t.firstName,e.user.lastName=t.lastName,e.user.city=t.city,e.user.state=t.state,e.user.cpf=t.cpf,e.user.emailVerified=t.emailVerified),e),redirect:async({url:e,baseUrl:t})=>e.startsWith("/")?`${t}${e}`:new URL(e).origin===t?e:t}}},89155:(e,t,a)=>{a.d(t,{K$:()=>s,MJ:()=>c,OS:()=>m,_I:()=>n});var r=a(45609);a(20330);var i=a(26109);let s={USER:"USER",ADMIN:"ADMIN"},n={DOCUMENT_READ:"document:read",DOCUMENT_WRITE:"document:write",DOCUMENT_DELETE:"document:delete",DOCUMENT_SHARE:"document:share",USER_READ:"user:read",USER_WRITE:"user:write",USER_DELETE:"user:delete",ADMIN_PANEL:"admin:panel",AUDIT_LOG_READ:"audit:read",SYSTEM_CONFIG:"system:config"},o={[s.USER]:[n.DOCUMENT_READ,n.DOCUMENT_WRITE,n.DOCUMENT_DELETE,n.DOCUMENT_SHARE],[s.ADMIN]:[...Object.values(n)]};async function l(e){var t;let a=await (0,r.getServerSession)(i.L);return!!a?.user?.role&&!!(t=a.user.role)&&(t&&o[t]||[]).includes(e)}async function u(e){let t=await (0,r.getServerSession)(i.L);return!!t?.user?.role&&t.user.role===e}async function d(){let e=await (0,r.getServerSession)(i.L);return e?.user?null:new Response(JSON.stringify({error:"Unauthorized",message:"Authentication required",code:"AUTH_REQUIRED"}),{status:401,headers:{"Content-Type":"application/json"}})}async function c(e){return await d()||(await l(e)?null:new Response(JSON.stringify({error:"Forbidden",message:`Missing required permission: ${e}`,code:"INSUFFICIENT_PERMISSIONS"}),{status:403,headers:{"Content-Type":"application/json"}}))}async function m(e){return await d()||(await u(e)?null:new Response(JSON.stringify({error:"Forbidden",message:`Missing required role: ${e}`,code:"INSUFFICIENT_ROLE"}),{status:403,headers:{"Content-Type":"application/json"}}))}},20728:(e,t,a)=>{a.d(t,{_:()=>i});let r=require("@prisma/client"),i=globalThis.prisma??new r.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[948,532,70,23,330,575],()=>a(5686));module.exports=r})();